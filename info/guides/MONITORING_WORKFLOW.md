# 실시간 모니터링 처리 프로세스

> **Version:** 1.3.0
> **Created:** 2025-12-27
> **Last Updated:** 2025-12-27
> **Author:** Claude AI

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.3.0 | 2025-12-27 | 서비스 자동 시작 기능 추가 (Ollama, Next.js) |
| 1.2.0 | 2025-12-27 | 비동기 트리거 흐름도 추가, 스크래퍼/AI봇 자동 호출 구현 |
| 1.1.0 | 2025-12-27 | 처리 순서도 추가, AI 가공봇 정보 업데이트 |
| 1.0.0 | 2025-12-27 | 초기 문서 작성 |

---

## 1. 처리 순서도 (Flowchart)

```
                              ┌─────────────────────────────────────┐
                              │         시스템 시작                  │
                              └─────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    모니터링봇                                            │
│                              (light_monitor.py)                                         │
│                                                                                         │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│   │  광주시청   │     │  전라남도   │     │   목포시    │ ... │   신안군    │          │
│   └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘          │
│          │                   │                   │                   │                  │
│          └───────────────────┴───────────────────┴───────────────────┘                  │
│                                         │                                               │
│                                         ▼                                               │
│                              ┌─────────────────────┐                                    │
│                              │  새 기사 있는가?    │                                    │
│                              └─────────────────────┘                                    │
│                                    │         │                                          │
│                              YES   │         │   NO                                     │
│                                    ▼         ▼                                          │
│                    ┌───────────────────┐  ┌─────────────────┐                          │
│                    │ 해당 지역 스크래퍼 │  │ 다음 주기 대기   │                          │
│                    │     호출          │  │ (30분/1시간/2시간)│                          │
│                    └───────────────────┘  └─────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                               지역 스크래퍼봇 (26개)                                     │
│                           (scrapers/[region]/main.py)                                   │
│                                                                                         │
│   예: 나주시에서 새 기사 감지됨                                                          │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │                         나주 스크래퍼 실행                               │          │
│   │                                                                         │          │
│   │   1. Playwright 브라우저 실행 (스텔스 모드)                              │          │
│   │   2. 기사 상세 페이지 방문                                               │          │
│   │   3. 제목, 본문, 이미지, 날짜 추출                                       │          │
│   │   4. DB 저장 (status = 'pending')                                       │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  승인대기 상태                                           │
│                              (Supabase posts 테이블)                                    │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │  posts 테이블                                                           │          │
│   │  ┌────────┬────────────────┬──────────┬─────────────┐                   │          │
│   │  │   id   │     title      │  status  │  region     │                   │          │
│   │  ├────────┼────────────────┼──────────┼─────────────┤                   │          │
│   │  │  1234  │ 나주시 보도... │ pending  │  naju       │  <-- 승인대기     │          │
│   │  │  1235  │ 목포시 발표... │ pending  │  mokpo      │  <-- 승인대기     │          │
│   │  │  1230  │ 광주시 정책... │ published│  gwangju    │  <-- 발행완료     │          │
│   │  └────────┴────────────────┴──────────┴─────────────┘                   │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AI 가공봇                                            │
│                         (tools/batch_process_articles.js)                               │
│                         (tools/update_existing_articles.js)                             │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │                         AI 가공 프로세스                                 │          │
│   │                                                                         │          │
│   │   1. pending 상태 기사 조회                                              │          │
│   │   2. Ollama/Claude API 호출                                             │          │
│   │   3. 기사 요약 생성                                                     │          │
│   │   4. 카테고리 자동 분류                                                  │          │
│   │   5. 문체 정리/교정                                                     │          │
│   │   6. status = 'published' 업데이트                                      │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                      발행 완료                                          │
│                              (koreanewsone.com 노출)                                    │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │                                                                         │          │
│   │    [코리아뉴스]  홈  |  정치  |  경제  |  사회  |  문화  |  전남        │          │
│   │   ─────────────────────────────────────────────────────────────────    │          │
│   │                                                                         │          │
│   │    [NEW] 나주시, 2025년 신규 정책 발표                                  │          │
│   │    나주시는 오늘 2025년 주요 정책을 발표했다...                         │          │
│   │                                                                         │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 간략 흐름도

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  모니터링봇  │ -> │ 지역스크래퍼 │ -> │  승인대기   │ -> │  AI가공봇   │ -> │    발행     │
│   (감지)    │    │   (수집)    │    │   (저장)    │    │   (가공)    │    │  (게시)     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                  │                  │                  │                  │
       ▼                  ▼                  ▼                  ▼                  ▼
  26개 지역          Playwright         pending 상태      Ollama/Claude      published
  HTTP 점검          기사 수집          DB 저장          AI 가공            사이트 노출
```

---

## 3. 단계별 상세

### 3.1 모니터링봇 (감지)

| 항목 | 내용 |
|------|------|
| **역할** | 26개 지자체 보도자료 게시판 변화 감지 |
| **방식** | 경량 HTTP 요청 (Playwright 미사용) |
| **주기** | 업무시간 30분, 저녁 2시간, 새벽 1시간 |
| **결과** | 새 기사 ID/URL 목록 |

**핵심 파일:**
- `scrapers/utils/light_monitor.py`
- `scrapers/utils/advanced_stealth.py`

### 3.2 지역 스크래퍼봇 (수집)

| 항목 | 내용 |
|------|------|
| **역할** | 해당 지역 기사 상세 내용 수집 |
| **개수** | 26개 지역별 스크래퍼 |
| **방식** | Playwright 브라우저 자동화 |
| **결과** | 제목, 본문, 이미지, 작성일 등 |

**지역 스크래퍼 목록 (26개):**
```
gwangju, jeonnam, mokpo, yeosu, suncheon, naju, gwangyang,
damyang, gokseong, gurye, goheung, boseong, hwasun, jangheung,
gangjin, haenam, yeongam, muan, hampyeong, yeonggwang, jangseong,
wando, jindo, shinan, gwangju_edu, jeonnam_edu
```

**핵심 파일:**
- `scrapers/[region]/main.py`
- `scrapers/configs/regional_configs.py`

### 3.3 승인대기 (저장)

| 항목 | 내용 |
|------|------|
| **역할** | 수집된 기사를 임시 저장 |
| **상태** | `status = 'pending'` 또는 `'draft'` |
| **저장소** | Supabase `posts` 테이블 |

### 3.4 AI 가공봇 (가공)

| 항목 | 내용 |
|------|------|
| **역할** | 승인대기 기사를 AI로 가공 |
| **기능** | 요약, 카테고리 분류, 문체 정리 |
| **AI 엔진** | Ollama (로컬) 또는 Claude API |
| **결과** | 가공된 기사 내용 |

**핵심 파일 (최신순):**
- `tools/batch_process_articles.js` (2025-12-27) - 배치 AI 가공
- `tools/update_existing_articles.js` (2025-12-27) - 기존 기사 업데이트

### 3.5 발행 (게시)

| 항목 | 내용 |
|------|------|
| **역할** | 가공 완료된 기사 발행 |
| **상태** | `status = 'published'` |
| **노출** | koreanewsone.com 사이트에 게시 |

---

## 4. 상태 전이도 (Status Flow)

```
                    ┌─────────────────────┐
                    │     기사 수집됨      │
                    └─────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │  status = 'pending' │  <-- 승인대기
                    └─────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
          ┌─────────────────┐  ┌─────────────────┐
          │  AI 가공 시작   │  │  수동 승인/거절  │
          └─────────────────┘  └─────────────────┘
                    │                   │
                    ▼                   ▼
          ┌─────────────────┐  ┌─────────────────┐
          │ status='draft'  │  │status='rejected'│
          │  (가공중)       │  │  (거절됨)       │
          └─────────────────┘  └─────────────────┘
                    │
                    ▼
          ┌─────────────────────┐
          │ status = 'published'│  <-- 발행완료
          └─────────────────────┘
                    │
                    ▼
          ┌─────────────────────┐
          │  사이트 노출        │
          │ (koreanewsone.com) │
          └─────────────────────┘
```

---

## 5. 이벤트 로그 타입

| event_type | 의미 | 발생 시점 |
|------------|------|----------|
| `check` | 점검 | 지역 사이트 방문 |
| `new_article` | 새글 감지 | 새 기사 발견 |
| `scrape` | 추출 | 스크래퍼가 기사 수집 |
| `ai` | AI 가공 | AI가 기사 처리 |
| `publish` | 발행 | 기사 게시 완료 |
| `block` | 차단 | 사이트 접근 차단됨 |
| `error` | 오류 | 처리 중 오류 발생 |
| `start` | 시작 | 모니터링 시작 |
| `stop` | 중지 | 모니터링 중지 |

---

## 6. DB 테이블

| 테이블 | 용도 |
|--------|------|
| `realtime_monitor` | 모니터링 상태 (is_running, config) |
| `monitor_activity_log` | 활동 로그 |
| `scraper_state` | 지역별 스크래퍼 상태 |
| `posts` | 기사 저장 (pending/published) |

---

## 7. 시간대별 점검 간격

| 시간대 | 간격 | 비고 |
|--------|------|------|
| 09:00 ~ 18:00 | 30분 | 업무시간 (기사 활발) |
| 18:00 ~ 23:00 | 2시간 | 저녁시간 |
| 07:00 ~ 09:00 | 1시간 | 새벽시간 |
| 23:00 ~ 07:00 | 중지 | 야간 (기사 없음) |

---

## 8. 차단 대응 전략

```
차단 감지 → 쿨다운 적용 → 아이덴티티 교체 → 재시도
```

| 연속 차단 | 쿨다운 시간 | 요청 간격 배수 |
|----------|------------|---------------|
| 1회 | 30분 | 1.5x |
| 2회 | 1시간 | 2.0x |
| 3회 | 2시간 | 2.5x |
| 4회 | 4시간 | 3.0x |
| 5회+ | 8시간 | 5.0x |

---

## 9. 비동기 트리거 흐름도 (Async Trigger Flow)

모니터링봇이 새 기사를 발견하면 다음 과정이 **비동기**로 진행됩니다:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    비동기 트리거 처리 흐름                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  모니터링봇이 나주시 점검 중...
     │
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  check_region('naju', config, last_id)                                      │
│                                                                             │
│  결과:                                                                       │
│    has_new = True                                                           │
│    new_article_ids = ['12345', '12346']                                     │
└─────────────────────────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        비동기 트리거 시작                                    │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  1. 지역 스크래퍼 비동기 호출                                        │   │
│   │     subprocess.Popen([                                              │   │
│   │         'python', 'scrapers/naju/naju_scraper.py',                  │   │
│   │         '--article-ids', '12345,12346'                              │   │
│   │     ])                                                              │   │
│   │                                                                     │   │
│   │     ※ 백그라운드 실행 → 모니터링봇은 다음 지역으로 이동              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  2. AI 가공봇 트리거 (선택적)                                        │   │
│   │     스크래퍼 완료 후 또는 일정 시간 후 자동 실행                      │   │
│   │                                                                     │   │
│   │     방법 A: 스크래퍼가 완료 후 직접 호출                             │   │
│   │     방법 B: 별도 스케줄러가 pending 기사 감지 시 호출                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
     │
     ▼  (모니터링봇은 바로 다음 지역으로)
┌─────────────────────────────────────────────────────────────────────────────┐
│  check_region('gwangyang', config, last_id)  ← 다음 지역 점검              │
└─────────────────────────────────────────────────────────────────────────────┘


                    ┌──────────────────────────────────────┐
                    │         백그라운드 프로세스           │
                    └──────────────────────────────────────┘
                                      │
         ┌────────────────────────────┼────────────────────────────┐
         ▼                            ▼                            ▼
   ┌──────────────┐            ┌──────────────┐            ┌──────────────┐
   │ 나주 스크래퍼 │            │ 목포 스크래퍼 │            │ AI 가공봇    │
   │  (실행중)    │            │  (대기중)    │            │  (대기중)    │
   └──────────────┘            └──────────────┘            └──────────────┘
         │
         ▼
   ┌──────────────────────────────────────────────────────────────────────┐
   │  스크래퍼 완료                                                        │
   │                                                                       │
   │  1. 기사 2건 DB 저장 (status = 'pending')                             │
   │  2. AI 가공봇 트리거 신호 발송                                         │
   │     POST /api/bot/trigger-ai-process                                  │
   │     { region: 'naju', article_ids: [123, 124] }                       │
   └──────────────────────────────────────────────────────────────────────┘
         │
         ▼
   ┌──────────────────────────────────────────────────────────────────────┐
   │  AI 가공봇 실행                                                       │
   │                                                                       │
   │  1. pending 상태 기사 조회                                            │
   │  2. Ollama API 호출 (제목/요약/카테고리)                               │
   │  3. status = 'published' 업데이트                                     │
   │  4. 사이트 노출                                                       │
   └──────────────────────────────────────────────────────────────────────┘
```

### 9.1 핵심 함수: `trigger_scraper()`

```python
# scrapers/utils/light_monitor.py

async def trigger_scraper(region_code: str, article_ids: List[str]) -> bool:
    """
    Trigger regional scraper asynchronously.
    Returns immediately, scraper runs in background.
    """
    import subprocess

    scraper_path = f"scrapers/{region_code}/{region_code}_scraper.py"

    # Run in background (non-blocking)
    subprocess.Popen([
        sys.executable,
        scraper_path,
        '--article-ids', ','.join(article_ids),
        '--trigger-ai'  # Auto-trigger AI processing after completion
    ])

    return True
```

### 9.2 AI 가공봇 트리거

```python
# scrapers/utils/light_monitor.py

async def trigger_ai_process(region_code: str, article_ids: List[str]) -> bool:
    """
    Trigger AI processing bot via API.
    """
    import httpx

    async with httpx.AsyncClient() as client:
        response = await client.post(
            'http://localhost:3000/api/bot/trigger-ai-process',
            json={
                'region': region_code,
                'article_ids': article_ids,
                'mode': 'lightweight'
            },
            headers={'x-api-key': os.environ.get('BOT_API_KEY')}
        )
        return response.status_code == 200
```

### 9.3 서비스 자동 시작 (Auto-Start Services)

AI 가공봇 트리거 시, 필요한 서비스들이 자동으로 시작됩니다:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    서비스 자동 시작 흐름 (v1.3.0)                            │
└─────────────────────────────────────────────────────────────────────────────┘

  trigger_ai_process() 호출
     │
     ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Step 1: Ollama 서버 확인                                                │
  │                                                                         │
  │  check_server_running('localhost', 11434)                               │
  │     │                                                                   │
  │     ├─ 실행 중이면 → 다음 단계                                           │
  │     │                                                                   │
  │     └─ 미실행이면 → start_ollama_server()                               │
  │                      │                                                  │
  │                      ▼                                                  │
  │                    subprocess.Popen(['ollama', 'serve'])                │
  │                      │                                                  │
  │                      ▼                                                  │
  │                    최대 30초 대기 (1초마다 포트 체크)                     │
  └─────────────────────────────────────────────────────────────────────────┘
     │
     ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Step 2: Next.js 서버 확인                                               │
  │                                                                         │
  │  check_server_running('localhost', 3000)                                │
  │     │                                                                   │
  │     ├─ 실행 중이면 → 다음 단계                                           │
  │     │                                                                   │
  │     └─ 미실행이면 → start_nextjs_server()                               │
  │                      │                                                  │
  │                      ▼                                                  │
  │                    subprocess.Popen(['npm', 'run', 'dev'])              │
  │                      │                                                  │
  │                      ▼                                                  │
  │                    최대 60초 대기 (Next.js는 시작이 느림)                 │
  └─────────────────────────────────────────────────────────────────────────┘
     │
     ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Step 3: AI 가공 API 호출                                                │
  │                                                                         │
  │  POST http://localhost:3000/api/bot/trigger-ai-process                  │
  │  {                                                                      │
  │      "region": "naju",                                                  │
  │      "article_ids": [123, 124],                                         │
  │      "mode": "lightweight"                                              │
  │  }                                                                      │
  └─────────────────────────────────────────────────────────────────────────┘
```

**핵심 함수들:**

```python
# 포트로 서버 실행 여부 체크
def check_server_running(host: str, port: int) -> bool:
    import socket
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    result = sock.connect_ex((host, port))
    sock.close()
    return result == 0

# Ollama 서버 시작
def start_ollama_server() -> bool:
    if check_server_running('localhost', 11434):
        return True  # Already running

    subprocess.Popen(['ollama', 'serve'], ...)
    # Wait up to 30 seconds for startup

# Next.js 서버 시작
def start_nextjs_server() -> bool:
    if check_server_running('localhost', 3000):
        return True  # Already running

    subprocess.Popen(['npm', 'run', 'dev'], ...)
    # Wait up to 60 seconds for startup

# 모든 서비스 시작
def ensure_services_running() -> Tuple[bool, bool]:
    ollama_ready = start_ollama_server()
    nextjs_ready = start_nextjs_server()
    return ollama_ready, nextjs_ready
```

**사용 예시:**

```python
# 서비스 자동 시작 활성화 (기본값)
trigger_ai_process(
    region_code='naju',
    article_ids=[123, 124],
    auto_start_services=True  # 기본값
)

# 서비스 자동 시작 비활성화 (서버가 이미 실행 중인 경우)
trigger_ai_process(
    region_code='naju',
    article_ids=[123, 124],
    auto_start_services=False
)
```

---

## 10. 트리거 설정 옵션

| 설정 | 기본값 | 설명 |
|------|--------|------|
| `auto_trigger_scraper` | `True` | 새 기사 감지 시 자동으로 스크래퍼 호출 |
| `auto_trigger_ai` | `True` | 스크래퍼 완료 후 자동으로 AI 가공 시작 |
| `auto_start_services` | `True` | AI 트리거 시 Ollama/Next.js 자동 시작 |
| `scraper_timeout` | `300` | 스크래퍼 최대 실행 시간 (초) |
| `ai_batch_size` | `10` | AI 가공 배치 크기 |
| `ollama_start_timeout` | `30` | Ollama 시작 대기 시간 (초) |
| `nextjs_start_timeout` | `60` | Next.js 시작 대기 시간 (초) |

---

## 11. TODO / 미완성 항목

- [x] 모니터링봇 → 지역 스크래퍼 자동 호출 로직 구현 (v1.2.0)
- [x] 승인대기 → AI가공 자동 트리거 구현 (v1.2.0)
- [x] Ollama/Next.js 서비스 자동 시작 기능 (v1.3.0)
- [ ] 에러 복구 자동화
- [ ] 모니터링 대시보드 알림 기능

---

## 12. 관련 문서

- [스크래퍼 개발 가이드](../../scrapers/SCRAPER_GUIDE.md)
- [백엔드 가이드](../backend.md)
- [에러 카탈로그](../errors/_catalog.md)

---

*이 문서는 모니터링 시스템이 발전함에 따라 지속적으로 업데이트됩니다.*
