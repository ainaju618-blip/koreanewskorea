# 시스템 아키텍처

> 주역 점술 서비스 Yu-1의 전체 시스템 구조

---

## 1. 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                     Next.js 16 (React 19)                             │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│  │  │  app/       │  │ components/ │  │   lib/      │  │   types/    │  │  │
│  │  │  (Pages)    │  │  (UI 15개)  │  │  api.ts     │  │ layoutStyles│  │  │
│  │  │  9 pages    │  │  DivinFlow  │  │  (Client)   │  │    .ts      │  │  │
│  │  │             │  │  Dice3D     │  │             │  │             │  │  │
│  │  │             │  │  HeroSect.  │  │             │  │             │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────┬────────────────────────────────────────────┘
                                 │
                                 │ HTTP/REST (JSON)
                                 │ Port: 3001 → 8000
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              SERVER LAYER                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                     FastAPI (Python 3.11+)                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        API Layer                                │  │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │  │  │
│  │  │  │ divination.py│  │ questions.py │  │  settings.py │          │  │  │
│  │  │  │  /cast       │  │  /search     │  │  /config     │          │  │  │
│  │  │  │  /today      │  │  /category   │  │              │          │  │  │
│  │  │  │  /categories │  │  /popular    │  │              │          │  │  │
│  │  │  └──────┬───────┘  └──────┬───────┘  └──────────────┘          │  │  │
│  │  └─────────┼─────────────────┼─────────────────────────────────────┘  │  │
│  │            │                 │                                         │  │
│  │  ┌─────────▼─────────────────▼─────────────────────────────────────┐  │  │
│  │  │                      UseCase Layer                              │  │  │
│  │  │  ┌───────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │              divination_usecase.py                        │  │  │  │
│  │  │  │  - 비즈니스 로직 조합                                     │  │  │  │
│  │  │  │  - AI 해석 가이드라인 v1.0 적용                           │  │  │  │
│  │  │  │  - 5단계 점술가 해석 생성                                 │  │  │  │
│  │  │  └───────────────────────────────────────────────────────────┘  │  │  │
│  │  └─────────────────────────────┬───────────────────────────────────┘  │  │
│  │                                │                                       │  │
│  │  ┌─────────────────────────────▼───────────────────────────────────┐  │  │
│  │  │                      Service Layer                              │  │  │
│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │  │  │
│  │  │  │divination  │ │  oracle_   │ │ category_  │ │   llm_     │   │  │  │
│  │  │  │   .py      │ │ generator  │ │  matcher   │ │  service   │   │  │  │
│  │  │  │ (시초점)   │ │   .py      │ │    .py     │ │    .py     │   │  │  │
│  │  │  └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ └─────┬──────┘   │  │  │
│  │  │        │              │              │              │           │  │  │
│  │  │  ┌─────┴──────┐ ┌─────┴──────┐ ┌─────┴──────┐ ┌─────┴──────┐   │  │  │
│  │  │  │   rag_     │ │   rag_     │ │   llm_     │ │            │   │  │  │
│  │  │  │ service.py │ │ pipeline.py│ │ validator  │ │            │   │  │  │
│  │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │  │  │
│  │  └─────────────────────────────┬───────────────────────────────────┘  │  │
│  │                                │                                       │  │
│  │  ┌─────────────────────────────▼───────────────────────────────────┐  │  │
│  │  │                    Repository Layer                             │  │  │
│  │  │  ┌────────────────────────┐  ┌────────────────────────┐        │  │  │
│  │  │  │  hexagram_repository   │  │    yao_repository      │        │  │  │
│  │  │  │       .py              │  │         .py            │        │  │  │
│  │  │  │  - 64괘 데이터 조회    │  │  - 384효 데이터 조회   │        │  │  │
│  │  │  └───────────┬────────────┘  └───────────┬────────────┘        │  │  │
│  │  └──────────────┼───────────────────────────┼──────────────────────┘  │  │
│  │                 │                           │                          │  │
│  │  ┌──────────────▼───────────────────────────▼──────────────────────┐  │  │
│  │  │                        Data Layer                               │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │  │  │
│  │  │  │ hexagram_    │ │ yao_         │ │ category_    │            │  │  │
│  │  │  │ complete.py  │ │ complete.py  │ │ seed.py      │            │  │  │
│  │  │  │ (64괘)       │ │ (384효)      │ │ (250분류)    │            │  │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘            │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │  │  │
│  │  │  │ daily_       │ │interpretation│ │ fortune/yao/ │            │  │  │
│  │  │  │ fortune.py   │ │ _matrix.py   │ │ question_dir │            │  │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘            │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────┬────────────────────────────────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│   PostgreSQL    │   │    ChromaDB     │   │     Ollama      │
│  (RDBMS 저장)   │   │  (벡터 검색)    │   │   (LLM 어투)    │
│                 │   │                 │   │                 │
│  - hexagrams    │   │  - RAG 검색     │   │  - qwen2.5:7b   │
│  - yaos         │   │  - 유사 질문    │   │  - 어투 변환    │
│  - categories   │   │                 │   │  - 분류 보조    │
│  - user_history │   │                 │   │                 │
└─────────────────┘   └─────────────────┘   └─────────────────┘
```

---

## 2. 데이터 플로우

### 2.1 점술 수행 플로우 (POST /api/divination/cast)

```
[사용자]
    │
    ▼ 질문 입력 + 카테고리 선택
┌─────────────────────────────────────────────────────────────────┐
│                         FRONTEND                                 │
│  DivinationFlow.tsx → lib/api.ts::castDivination()              │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼ POST /api/divination/cast
┌─────────────────────────────────────────────────────────────────┐
│                          BACKEND                                 │
│                                                                  │
│  1. API Layer (divination.py)                                    │
│     └─→ Request 파싱 및 검증                                    │
│         └─→ DivinationRequest → DivinationUseCase               │
│                                                                  │
│  2. UseCase Layer (divination_usecase.py)                        │
│     ├─→ 2.1 카테고리 매칭 (category_matcher.py)                 │
│     │       └─→ 질문 분석 → 9대분류 + 250소분류 매핑            │
│     │                                                            │
│     ├─→ 2.2 점술 수행 (divination.py)                           │
│     │       └─→ uniform_384_divination()                        │
│     │           ├─→ 운발수(1-10) 산출                           │
│     │           ├─→ 가중치 기반 384효 선택                      │
│     │           └─→ DivinationResult 반환                       │
│     │                                                            │
│     ├─→ 2.3 괘/효 데이터 조회                                   │
│     │       ├─→ hexagram_repository.get_hexagram()              │
│     │       └─→ yao_repository.get_yao()                        │
│     │                                                            │
│     ├─→ 2.4 질문 방향 분석 (question_direction.py)              │
│     │       └─→ 시작/유지/변화/종료 판정                        │
│     │                                                            │
│     ├─→ 2.5 효사 방향 분석 (yao_direction.py)                   │
│     │       └─→ 상승/정체/하강 판정                             │
│     │                                                            │
│     ├─→ 2.6 결합 매트릭스 조회 (interpretation_matrix.py)       │
│     │       └─→ 12가지 행동 지침 매핑                           │
│     │                                                            │
│     ├─→ 2.7 5단계 점술가 해석 생성 (oracle_generator.py)        │
│     │       ├─→ Stage 1: 괘/효 선언 (10%)                       │
│     │       ├─→ Stage 2: 핵심 해석 (25%)                        │
│     │       ├─→ Stage 3: 맥락 적용 (30%)                        │
│     │       ├─→ Stage 4: 행동 지침 (25%)                        │
│     │       └─→ Stage 5: 마무리 경구 (10%)                      │
│     │                                                            │
│     └─→ 2.8 LLM 어투 변환 (llm_service.py)                      │
│             └─→ Ollama API → 점술가 어조 (~이니라, ~하라)       │
│                                                                  │
│  3. Response 조합                                                │
│     └─→ DivinationOutput → DivinationResponse                   │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼ JSON Response
┌─────────────────────────────────────────────────────────────────┐
│                         FRONTEND                                 │
│  ResultCard.tsx → 결과 표시                                      │
│  - 괘명, 효사, 해석, 길흉 점수, 행동 지침                       │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 오늘의 운세 플로우 (GET /api/divination/today)

```
[사용자]
    │
    ▼ 홈 화면 접속
┌─────────────────────────────────────────────────────────────────┐
│  HeroSection.tsx → lib/api.ts::getTodayFortune()                │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼ GET /api/divination/today
┌─────────────────────────────────────────────────────────────────┐
│  1. 날짜 기반 시드 설정 (같은 날 = 같은 운세)                   │
│     seed = YYYYMMDD                                              │
│                                                                  │
│  2. 시초법으로 점 치기 (운발수 가중치 적용)                     │
│     - 운발수 1-2: 흉운 (나쁜 운세 ↑)                            │
│     - 운발수 5-6: 평운 (균등)                                   │
│     - 운발수 9-10: 대길운 (좋은 운세 ↑)                         │
│                                                                  │
│  3. 일간운세 전용 해석문 조회                                    │
│     - daily_fortune_generated.py                                 │
│     - 3일마다 변형 순환 (variation 0~2)                         │
│                                                                  │
│  4. TodayFortuneResponse 반환                                    │
│     - daily_headline: 대제목 (15-25자)                          │
│     - daily_body: 본문 (50-70자)                                │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 질문 검색 플로우 (GET /api/questions/search)

```
[사용자] ─→ 검색어 입력
              │
              ▼
┌─────────────────────────────────────────────────────────────────┐
│  QuestionSearch.tsx → lib/api.ts::searchQuestions()             │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼ GET /api/questions/search?q={query}
┌─────────────────────────────────────────────────────────────────┐
│  1. 데이터 로드 (Lazy Loading)                                   │
│     - questions_unified.json (9,491개 질문)                     │
│     - keywords_index.json (9,975개 키워드 역인덱스)             │
│                                                                  │
│  2. 검색 수행                                                    │
│     - 키워드 인덱스 검색 (정확 매칭)                            │
│     - 텍스트 직접 검색 (부분 일치)                              │
│     - 점수 기반 정렬                                            │
│                                                                  │
│  3. 카테고리 필터 적용 (optional)                               │
│                                                                  │
│  4. SearchResponse 반환                                          │
│     - 질문 목록 + 카테고리 정보 + 매칭 점수                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 핵심 모듈 관계도

### 3.1 Backend 모듈 의존성

```
                              main.py
                                 │
                 ┌───────────────┼───────────────┐
                 │               │               │
                 ▼               ▼               ▼
          divination.py    questions.py    settings.py
          (API Router)     (API Router)    (API Router)
                 │               │
                 │               │
                 ▼               │
    ┌────────────────────────┐   │
    │  divination_usecase.py │   │
    │  (비즈니스 조합)       │   │
    └───────────┬────────────┘   │
                │                │
    ┌───────────┼────────────────┼───────────┐
    │           │                │           │
    ▼           ▼                ▼           ▼
┌────────┐ ┌────────┐ ┌──────────────┐ ┌────────────┐
│divinat │ │oracle_ │ │ category_    │ │ llm_       │
│ion.py  │ │generat │ │ matcher.py   │ │ service.py │
│        │ │or.py   │ │              │ │            │
│ 시초점 │ │ 5단계  │ │ 질문→분류   │ │ 어투 변환  │
│ 알고리 │ │ 해석   │ │ 키워드매칭   │ │ Ollama     │
│ 즘     │ │ 생성   │ │              │ │            │
└───┬────┘ └───┬────┘ └──────┬───────┘ └─────┬──────┘
    │          │             │               │
    │          │             │               │
    │          ▼             │               ▼
    │     ┌─────────┐        │         ┌─────────────┐
    │     │yao_     │        │         │llm_         │
    │     │direction│        │         │validator.py │
    │     │.py      │        │         │ 환각 검증   │
    │     └─────────┘        │         └─────────────┘
    │          │             │
    │          ▼             │
    │     ┌─────────────┐    │
    │     │question_    │    │
    │     │direction.py │    │
    │     └─────────────┘    │
    │          │             │
    │          ▼             │
    │     ┌─────────────────┐│
    │     │interpretation_  ││
    │     │matrix.py        ││
    │     │ 12가지 행동지침 ││
    │     └─────────────────┘│
    │                        │
    ▼                        ▼
┌────────────────┐    ┌────────────────┐
│hexagram_       │    │yao_            │
│repository.py   │    │repository.py   │
│ 64괘 조회      │    │ 384효 조회     │
└───────┬────────┘    └───────┬────────┘
        │                     │
        ▼                     ▼
┌─────────────────────────────────────────┐
│              Data Layer                  │
│  hexagram_complete.py  yao_complete.py  │
│  category_seed.py      daily_fortune.py │
│  fortune_direction.py  psychology.py    │
└─────────────────────────────────────────┘
```

### 3.2 Frontend 컴포넌트 관계도

```
                           layout.tsx
                               │
                    ┌──────────┼──────────┐
                    │          │          │
                    ▼          ▼          ▼
              Header.tsx    page.tsx   [other pages]
                               │
              ┌────────────────┼────────────────┐
              │                │                │
              ▼                ▼                ▼
       HeroSection.tsx   QuickCategory   PopularQuestions
       (일간운세 표시)      .tsx             .tsx
              │
              └─────────────────────┐
                                    │
                        ┌───────────┼───────────┐
                        │           │           │
                        ▼           ▼           ▼
                 divination/    history/     admin/
                  page.tsx      page.tsx    page.tsx
                        │
         ┌──────────────┼──────────────┐
         │              │              │
         ▼              ▼              ▼
   CategorySelector  QuestionSearch  DivinationFlow
        .tsx            .tsx             .tsx
                        │                   │
              ┌─────────┴───────┐           │
              │                 │           │
              ▼                 ▼           ▼
      QuestionSuggestion  PopularQuestions  │
           .tsx              .tsx           │
                                            │
         ┌──────────────────────────────────┤
         │              │              │    │
         ▼              ▼              ▼    ▼
     Dice3D.tsx   OctahedronDice   YaoSlider  ResultCard
                     .tsx           .tsx       .tsx
```

### 3.3 API 클라이언트 (lib/api.ts)

```
┌─────────────────────────────────────────────────────────────────┐
│                         lib/api.ts                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  BASE_URL = http://localhost:8000/api                           │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Divination APIs                                         │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │ castDivination(request)     → POST /divination/cast     │    │
│  │ castByQuestion(question)    → POST /divination/cast-by-q│    │
│  │ getTodayFortune()           → GET  /divination/today    │    │
│  │ getCategories()             → GET  /divination/categories│   │
│  │ getSubCategories(id)        → GET  /divination/cat/{id} │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Questions APIs                                          │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │ searchQuestions(q, cat)     → GET  /questions/search    │    │
│  │ getCategoryQuestions(id)    → GET  /questions/cat/{id}  │    │
│  │ getRandomQuestions(cat)     → GET  /questions/random    │    │
│  │ getPopularQuestions(cat)    → GET  /questions/popular   │    │
│  │ suggestQuestions(text)      → GET  /questions/suggest   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 데이터 계층 상세

### 4.1 정적 데이터 (Python)

| 파일 | 데이터 | 용량 |
|------|--------|------|
| `hexagram_complete.py` | 64괘 완전 데이터 | ~2.3MB |
| `yao_complete.py` | 384효 완전 데이터 | ~7.3MB |
| `category_seed.py` | 9대분류 + 250소분류 | ~1.4MB |
| `interpretations_seed.py` | 카테고리별 해석 | ~1.2MB |
| `daily_fortune_final.py` | 일일운세 템플릿 | ~1.6MB |
| `interpretation_matrix.py` | 12가지 행동지침 | ~50KB |
| `fortune_direction.py` | 길흉 방향 매핑 | ~30KB |
| `yao_direction.py` | 효사 상승/정체/하강 | ~40KB |
| `question_direction.py` | 질문 시작/유지/변화/종료 | ~35KB |

### 4.2 동적 데이터 (JSON)

| 파일 | 데이터 | 항목 수 |
|------|--------|---------|
| `questions_unified.json` | 통합 질문 | 9,491개 |
| `keywords_index.json` | 키워드 역인덱스 | 9,975개 |
| `category_questions_map.json` | 카테고리별 매핑 | 9개 대분류 |

### 4.3 데이터 스키마

```python
# 괘 데이터 (HexagramData)
{
    "number": 1,                    # 1-64
    "name_ko": "건",                # 한글 1자
    "name_hanja": "乾",             # 한자 1자
    "name_full": "건위천",          # 풀네임
    "upper_trigram": "건",          # 상괘
    "lower_trigram": "건",          # 하괘
    "gua_ci": "元亨利貞",           # 괘사
    "meaning": "...",               # 괘 해석
}

# 효 데이터 (YaoData)
{
    "hexagram": 1,                  # 괘 번호
    "position": 1,                  # 1-6 (초효~상효)
    "name": "초구",                 # 효 이름
    "text_hanja": "潛龍勿用",       # 효사 한자
    "text_kr": "잠긴 용이니 쓰지 말라", # 직역
    "interpretation": "...",        # 해석
    "fortune_score": 50,            # 0-100 (길흉 점수)
    "fortune_category": "평",       # 대길/길/평/흉/대흉
    "keywords": ["신중", "기다림"], # 키워드
}

# 질문 데이터
{
    "id": "q_재물_001",
    "text": "오늘 비트코인 사도 될까요?",
    "major_category_id": 1,
    "major_category_name": "재물",
    "sub_category": "투자",
}
```

---

## 5. 기술 스택 요약

| 영역 | 기술 | 버전/설명 |
|------|------|-----------|
| **Frontend** | Next.js | 16.x (App Router) |
| | React | 19.x |
| | TypeScript | 5.x |
| | Tailwind CSS | 3.x |
| | Three.js / R3F | 3D 주사위 |
| **Backend** | FastAPI | 0.100+ |
| | Python | 3.11+ |
| | SQLAlchemy | 2.x (ORM) |
| | Pydantic | 2.x (검증) |
| **Database** | PostgreSQL | 15.x (운영) |
| | SQLite | 개발/테스트 |
| **AI/ML** | Ollama | 로컬 LLM |
| | qwen2.5:7b | 어투 변환 모델 |
| | ChromaDB | 벡터 검색 (RAG) |
| **DevOps** | Docker | 컨테이너화 |
| | Vercel | 프론트엔드 배포 |
| | Alembic | DB 마이그레이션 |

---

## 6. 포트 및 환경 변수

### 6.1 로컬 개발 포트

| 서비스 | 포트 | 용도 |
|--------|------|------|
| Frontend | 3001 | Next.js 개발 서버 |
| Backend | 8000 | FastAPI 서버 |
| Ollama | 11434 | LLM API |
| PostgreSQL | 5432 | 데이터베이스 |
| ChromaDB | 8001 | 벡터 DB |

### 6.2 주요 환경 변수

```env
# Backend (core/config.py)
DATABASE_URL=postgresql://user:pass@localhost:5432/yu1
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=qwen2.5:7b
CHROMA_PERSIST_DIR=./chroma_db
DEBUG=True

# Frontend (.env.local)
NEXT_PUBLIC_API_URL=http://localhost:8000
```

---

## 7. 관련 문서

- [데이터 인덱스](DATA_INDEX.md) - 전체 데이터 자산 목록
- [API 레퍼런스](API_REFERENCE.md) - API 상세 문서
- [AI 해석 가이드라인](AI_해석_가이드라인_v1.md) - 점술가 해석 규칙
- [서비스 설계](서비스_설계_v2.md) - 전체 서비스 기획
