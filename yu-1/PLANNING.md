# 주역 기반 AI 운세 서비스 기획서

## 1. 프로젝트 개요

### 1.1 서비스 비전
전통 주역(周易) 64괘 384효를 현대적으로 재해석하여, 사용자의 일상적 고민에 맞춤형 운세를 제공하는 AI 서비스

### 1.2 핵심 차별점
| 기존 운세 서비스 | 본 서비스 |
|-----------------|----------|
| AI가 운세 내용 생성 (환각 리스크) | 384효 고정 데이터 + AI는 어투만 변환 |
| 단일 점술 | 주역/사주/타로/타자 다중 선택 |
| 추상적 답변 | 250개 세분화 카테고리 맞춤 답변 |
| 원문 없음 | 주역 원문 + 현대 해석 병행 |

### 1.3 타겟 사용자
- **1차**: 20-40대 재테크/연애 고민 MZ세대
- **2차**: 전통 운세에 관심 있는 40-60대
- **3차**: 타로/사주 등 다양한 점술 수요층

---

## 2. 사용자 플로우 (5단계 UI)

### 2.1 전체 플로우
```
┌─────────────────────────────────────────────────────────────┐
│  STEP 0: 점술 선택                                          │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐             │
│  │주역 ●│ │ 사주 │ │ 타로 │ │ 타자 │ │더보기│             │
│  │384효 │ │4기둥 │ │78장  │ │12지지│ │      │             │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘             │
├─────────────────────────────────────────────────────────────┤
│  STEP 1: 기간 선택                                          │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                      │
│  │일간 ●│ │ 주간 │ │ 월간 │ │ 연간 │                      │
│  │TODAY │ │ WEEK │ │MONTH │ │ YEAR │                      │
│  └──────┘ └──────┘ └──────┘ └──────┘                      │
├─────────────────────────────────────────────────────────────┤
│  STEP 2: 대분류 선택 (9개)                                  │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐   │
│  │💰│ │💼│ │📚│ │💕│ │👥│ │🏥│ │🎮│ │✨│ │🔮│   │
│  │재물│ │직업│ │학업│ │연애│ │대인│ │건강│ │취미│ │운명│ │기타│   │
│  └───┘ └───┘ └───┘ └───┘ └───┘ └───┘ └───┘ └───┘ └───┘   │
├─────────────────────────────────────────────────────────────┤
│  STEP 3: 질문 입력 (100자 제한)                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ "이번 주 비트코인 사도 될까요?"                      │   │
│  │ 💡 자동매칭: 재물 > 코인/가상자산                    │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  STEP 4: 점 치기 (0.8초 로딩)                               │
│                 ☯️ 팔괘 회전 애니메이션                      │
├─────────────────────────────────────────────────────────────┤
│  STEP 5: 결과 출력                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🔮 화천대유(火天大有) 상효                           │   │
│  │                                                      │   │
│  │ "비트코인 매수, 이번 주는 좋은 타이밍!              │   │
│  │  하늘이 돕는 대길의 운입니다.                        │   │
│  │  다만 욕심 부리지 말고 분할 매수하세요~"             │   │
│  │                                                      │   │
│  │ 📊 길흉: ⭐⭐⭐⭐⭐ (95/100)                         │   │
│  │ 💡 핵심: 믿고 나아가되 교만 금물                     │   │
│  │                                                      │   │
│  │ [카톡공유] [다시보기] [저장하기]                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 카테고리 체계 (9대분류 → 250소분류)

#### 대분류 및 주요 소분류
| 대분류 | 소분류 예시 | 예상 비중 |
|--------|------------|----------|
| 💰 재물 | 주식/코인/부동산/N잡/대출/저축/복권 | 30% |
| 💼 직업 | 이직/연봉협상/창업/승진/퇴사/면접 | 20% |
| 📚 학업 | 시험/자격증/수능/공무원/편입/유학 | 10% |
| 💕 연애 | 썸/고백/재회/결혼/이별/불륜/소개팅 | 20% |
| 👥 대인 | 직장동료/친구/가족/이웃/SNS관계 | 5% |
| 🏥 건강 | 다이어트/수술/임신/정신건강/운동 | 5% |
| 🎮 취미 | 티켓팅/덕질/게임/여행/경마/로또 | 5% |
| ✨ 운명 | 전생/사주/꿈해몽/관상/이사방향 | 3% |
| 🔮 기타 | 분류 불가 질문 | 2% |

---

## 3. 데이터 설계

### 3.1 384효 마스터 DB

#### 테이블 구조: `hexagram_yao` (384행)
```sql
CREATE TABLE hexagram_yao (
    id SERIAL PRIMARY KEY,

    -- 괘 정보
    hexagram_number INT NOT NULL,          -- 1~64
    hexagram_name_kr VARCHAR(20),          -- 건, 곤, 준, 몽...
    hexagram_name_hanja VARCHAR(20),       -- 乾, 坤, 屯, 蒙...
    hexagram_name_full VARCHAR(50),        -- 건위천, 곤위지...

    -- 효 정보
    yao_position INT NOT NULL,             -- 1~6 (초효~상효)
    yao_type VARCHAR(10),                  -- 양효(九), 음효(六)
    yao_name VARCHAR(20),                  -- 초구, 구이, 구삼...

    -- 원문
    yao_text_hanja TEXT,                   -- 效辭 한자 원문
    yao_text_kr TEXT,                      -- 효사 한글 번역
    yao_interpretation TEXT,               -- 현대적 해석 (기본)

    -- 길흉 점수
    fortune_score INT,                     -- 0~100 (흉~대길)
    fortune_category VARCHAR(20),          -- 대길/길/평/흉/대흉

    -- 카테고리별 해석 (JSON)
    interpretations_by_category JSONB,     -- 250개 카테고리별 맞춤 해석

    -- 키워드
    keywords TEXT[],                       -- ['인내', '기다림', '신중']

    -- 시간 표현
    time_expressions JSONB,                -- 기간별 표현

    -- 메타
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_hexagram ON hexagram_yao(hexagram_number);
CREATE INDEX idx_fortune ON hexagram_yao(fortune_score);
CREATE INDEX idx_keywords ON hexagram_yao USING GIN(keywords);
```

#### 카테고리별 해석 JSON 구조
```json
{
  "interpretations_by_category": {
    "재물_코인": {
      "interpretation": "코인 시장에서 하늘이 돕는 때입니다. 분할 매수로 접근하세요.",
      "action_guide": "매수 타이밍 적합, 단 전재산 금물",
      "caution": "FOMO에 휘둘리지 말 것"
    },
    "재물_주식": {
      "interpretation": "주식 투자에 길한 운입니다. 우량주 중심으로.",
      "action_guide": "장기 투자 적합",
      "caution": "단타 지양"
    },
    "연애_썸": {
      "interpretation": "상대방도 당신에게 호감이 있습니다.",
      "action_guide": "적극적으로 다가가도 좋음",
      "caution": "너무 급하게 굴지 말 것"
    }
    // ... 250개 카테고리
  }
}
```

### 3.2 질문 데이터 수집 (RAG용)

#### 수집 대상 사이트
| 사이트 | 예상 질문 수 | 주요 카테고리 | 접근 방식 |
|--------|-------------|--------------|----------|
| DC인사이드 주식갤 | 500,000+ | 재물/투자 | 공개 API |
| 에펨코리아 | 200,000+ | 연애/직업 | 크롤링 |
| 블라인드 | 300,000+ | 직장/연봉 | 크롤링 |
| 뽐뿌 | 150,000+ | 부동산/구매 | 크롤링 |
| 네이버 지식인 | 무제한 | 전 카테고리 | 크롤링 |

#### 수집 데이터 구조
```sql
CREATE TABLE collected_questions (
    id SERIAL PRIMARY KEY,

    -- 원본 정보
    source_site VARCHAR(50),               -- dcinside, fmkorea...
    source_url TEXT,
    collected_at TIMESTAMP,

    -- 질문 정보
    question_text TEXT NOT NULL,
    question_length INT,

    -- 자동 분류
    auto_category_main INT,                -- 9대분류 중 하나
    auto_category_sub INT,                 -- 250소분류 중 하나
    category_confidence FLOAT,             -- 분류 신뢰도 0~1

    -- 키워드
    extracted_keywords TEXT[],

    -- 벡터 (RAG용)
    embedding VECTOR(768),                 -- 임베딩 벡터

    -- 상태
    is_processed BOOLEAN DEFAULT FALSE,
    is_valid BOOLEAN DEFAULT TRUE
);

-- 벡터 검색 인덱스
CREATE INDEX idx_embedding ON collected_questions
USING ivfflat (embedding vector_cosine_ops);
```

#### 크롤링 규칙
```
✅ 허용
- 공개 게시판만 (로그인 불필요)
- robots.txt 준수
- 초당 1회 요청 제한
- User-Agent 명시

❌ 금지
- 비공개/로그인 필요 게시판
- 개인정보 포함 게시글
- 댓글 수집
```

### 3.3 카테고리 테이블

```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,

    -- 분류
    main_category_id INT,                  -- 1~9 대분류
    main_category_name VARCHAR(20),        -- 재물, 직업...
    main_category_emoji VARCHAR(10),       -- 💰, 💼...

    sub_category_id INT,                   -- 1~250 소분류
    sub_category_name VARCHAR(50),         -- 코인, 주식, 부동산...

    -- 매칭 키워드
    keywords TEXT[],                       -- ['비트코인', 'BTC', '코인']
    keyword_priority INT,                  -- 키워드 우선순위

    -- 통계
    question_count INT DEFAULT 0,
    last_matched_at TIMESTAMP
);
```

---

## 4. 시스템 아키텍처

### 4.1 전체 구조
```
┌─────────────────────────────────────────────────────────────────┐
│                        사용자 (모바일/웹)                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Frontend (Next.js)                          │
│  - 5단계 UI 플로우                                              │
│  - 모바일 최적화 (PWA)                                          │
│  - 카카오/SNS 공유                                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Backend (FastAPI)                           │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ 질문 분석   │  │ 효 선택     │  │ 응답 생성   │            │
│  │ (카테고리)  │  │ (384효)     │  │ (LLM 어투)  │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│         │                │                │                    │
│         ▼                ▼                ▼                    │
│  ┌─────────────────────────────────────────────────┐          │
│  │              Redis (캐싱/세션)                   │          │
│  └─────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   PostgreSQL    │  │   ChromaDB      │  │   Ollama        │
│   (384효 DB)    │  │   (RAG 벡터)    │  │   (LLM 어투)    │
│                 │  │                 │  │                 │
│ - 384효 마스터  │  │ - 질문 임베딩   │  │ - Qwen2.5:7b    │
│ - 250카테고리   │  │ - 유사도 검색   │  │ - 어투만 변환   │
│ - 사용자 기록   │  │                 │  │                 │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

### 4.2 요청 처리 플로우
```
1. 사용자 질문 입력
   "이번 주 비트코인 사도 될까요?"
        │
        ▼
2. 카테고리 자동 매칭
   - 키워드 우선: "비트코인" → 재물 > 코인
   - 신뢰도 낮으면: LLM 보조 분류
        │
        ▼
3. 효 선택 (점 치기)
   - 방식: 전통 점괘 시뮬레이션 (시초점 알고리즘)
   - 결과: 384효 중 1개 확정
   - 예: 화천대유(14괘) 상효
        │
        ▼
4. 고정 데이터 추출
   - hexagram_yao 테이블에서 해당 효 조회
   - 카테고리(재물_코인)에 맞는 해석 추출
        │
        ▼
5. LLM 어투 변환 (Ollama)
   - 입력: 고정 해석 + 질문 컨텍스트
   - 출력: 자연스러운 어투로 변환
   - 토큰: ~200개 (최소화)
        │
        ▼
6. 결과 반환
   - 괘 이미지 + 효사 원문 + 현대 해석
   - 길흉 점수 + 행동 가이드
```

### 4.3 핵심 API 엔드포인트

```python
# 1. 점 치기 (메인)
POST /api/divination
{
    "divination_type": "iching",      # iching/saju/tarot/taja
    "period": "weekly",               # daily/weekly/monthly/yearly
    "main_category": 1,               # 1~9
    "question": "비트코인 사도 될까?"
}

Response:
{
    "hexagram": {
        "number": 14,
        "name_kr": "대유",
        "name_hanja": "大有",
        "name_full": "화천대유"
    },
    "yao": {
        "position": 6,
        "name": "상구",
        "text_hanja": "自天祐之 吉无不利",
        "text_kr": "하늘이 스스로 돕나니 길하여 이롭지 않음이 없다"
    },
    "interpretation": "비트코인 매수, 이번 주는 좋은 타이밍!...",
    "fortune_score": 95,
    "action_guide": "분할 매수 추천",
    "caution": "욕심 금물"
}

# 2. 카테고리 조회
GET /api/categories
GET /api/categories/{main_id}/sub

# 3. 히스토리 조회 (로그인 사용자)
GET /api/history
POST /api/history/save
```

---

## 5. LLM 전략

### 5.1 핵심 원칙
```
┌─────────────────────────────────────────────────────────────┐
│  LLM 역할 = 어투 변환만 (Content 생성 ❌)                   │
│                                                             │
│  ✅ LLM이 하는 일:                                          │
│     - 고정된 효사 해석을 자연스러운 문체로 변환             │
│     - 질문 맥락에 맞게 어미/표현 조정                       │
│     - 기간(일간/주간)에 맞는 시간 표현 삽입                 │
│                                                             │
│  ❌ LLM이 하지 않는 일:                                     │
│     - 운세 내용 자체를 생성 (환각 위험)                     │
│     - 길흉 판단 (DB 고정값 사용)                            │
│     - 새로운 해석 창작                                      │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 모델 선택

#### 1차 선택: Ollama + Qwen2.5:7b
| 항목 | 스펙 |
|------|------|
| 모델 | Qwen2.5:7b-instruct |
| VRAM | 5GB (RTX 3060 이상) |
| 한국어 | 우수 (다국어 학습) |
| 속도 | ~30 토큰/초 |
| 비용 | 무료 (로컬) |

#### 대안: 클라우드 LLM (트래픽 증가 시)
| 모델 | 비용 | 속도 | 용도 |
|------|------|------|------|
| Groq (Llama 3.1) | $0.05/1M | 초고속 | 메인 대안 |
| Claude Haiku | $0.25/1M | 빠름 | 고품질 필요시 |
| GPT-4o-mini | $0.15/1M | 보통 | 백업 |

### 5.3 프롬프트 설계

```python
STYLE_PROMPT = """
당신은 주역 점술가입니다.
아래 효사 해석을 친근하고 자연스러운 어투로 변환해주세요.

[규칙]
1. 내용은 절대 바꾸지 마세요. 어투만 변환합니다.
2. 150자 이내로 작성하세요.
3. {period}에 맞는 시간 표현을 사용하세요.
4. 너무 캐주얼하지 않게, 점술가다운 품위를 유지하세요.
5. 이모지는 1-2개만 사용하세요.

[원본 해석]
{original_interpretation}

[질문]
{user_question}

[카테고리]
{category}

[기간]
{period}

[변환된 답변]
"""
```

### 5.4 비용 예측

```
일일 1만 쿼리 기준:

Ollama (로컬):
  - 서버 비용: 월 10만원 (GPU 서버)
  - LLM 비용: 0원
  - 총: 월 10만원

Groq (클라우드):
  - 서버 비용: 월 3만원 (CPU only)
  - LLM 비용: 1만 × 200토큰 × 30일 × $0.05/1M = $3/월
  - 총: 월 3.5만원 (더 저렴!)
```

---

## 6. 데이터 생산 계획

### 6.1 384효 데이터 생산

#### Phase 1: 기본 데이터 (1주)
```
작업 내용:
1. 64괘 × 6효 = 384행 기본 정보 입력
   - 괘 이름 (한글/한자)
   - 효 위치 (1~6)
   - 효사 원문 (한자)
   - 효사 번역 (한글)

소스:
- 주역 원전 (공개 번역본)
- 위키백과 주역 문서
- 국립중앙도서관 고전 자료

담당: 1인 (데이터 입력)
예상 시간: 40시간
```

#### Phase 2: 현대 해석 (2주)
```
작업 내용:
1. 각 효별 현대적 해석 작성
2. 길흉 점수 (0~100) 부여
3. 키워드 3~5개 추출

기준:
- 효사 원문의 본래 의미 70-80% 유지
- 나머지 20-30%만 현대 맥락 추가

담당: 주역 전문가 1인 + 검수 1인
예상 시간: 80시간
```

#### Phase 3: 카테고리별 해석 (3주)
```
작업 내용:
1. 250개 소분류별 맞춤 해석 생성
2. 총 384 × 250 = 96,000개 해석

방식:
- 기본 해석을 템플릿으로 LLM 보조 생성
- 전문가 검수 (샘플링 10%)

담당: LLM + 검수 1인
예상 시간: 120시간
```

### 6.2 질문 데이터 수집

#### 자동 크롤링 파이프라인
```python
# 일일 실행 크롤러

def daily_crawl():
    sites = [
        {"name": "dcinside", "url": "...", "selector": "..."},
        {"name": "fmkorea", "url": "...", "selector": "..."},
        # ...
    ]

    for site in sites:
        questions = crawl_site(site, limit=10000)

        for q in questions:
            # 1. 중복 체크
            if is_duplicate(q): continue

            # 2. 개인정보 마스킹
            q = mask_pii(q)

            # 3. 카테고리 자동 분류
            category = classify_question(q)

            # 4. 임베딩 생성
            embedding = generate_embedding(q)

            # 5. DB 저장
            save_to_db(q, category, embedding)

    log(f"Daily crawl complete: {len(questions)} new questions")
```

#### 수집 목표
| 기간 | 누적 질문 수 | 카테고리 커버리지 |
|------|-------------|------------------|
| 1주차 | 100,000 | 80% |
| 2주차 | 300,000 | 90% |
| 1개월 | 1,000,000 | 98% |
| 3개월 | 3,000,000 | 99% |

---

## 7. 확장 계획

### 7.1 다중 점술 지원

#### 사주 (四柱)
```
데이터 구조:
- 10천간 × 12지지 = 120 기본 조합
- 4기둥 상호작용 = 복잡 계산

구현 방식:
- 생년월일시 입력 받음
- 만세력 API 연동
- 사주 해석 DB 별도 구축

예상 추가 공수: 2주
```

#### 타로 (Tarot)
```
데이터 구조:
- 78장 카드 (메이저 22 + 마이너 56)
- 정방향/역방향 = 156개 해석

구현 방식:
- 카드 이미지 라이선스 확보
- 스프레드 방식 선택 (원카드/쓰리카드)
- 인터넷 공개 해석 데이터 활용

예상 추가 공수: 1주
```

#### 타자 (생년 12지지)
```
데이터 구조:
- 12지지 × 12지지 = 144 궁합
- 연간 운세 12개

구현 방식:
- 주역 384효에서 12개 대표 효 매핑
- 간소화된 운세 제공

예상 추가 공수: 3일
```

### 7.2 수익화 모델

```
┌─────────────────────────────────────────────────────────────┐
│  무료 (Free)                                                │
│  - 주역 3회/일                                              │
│  - 타로 1회/일                                              │
│  - 기본 해석만                                              │
├─────────────────────────────────────────────────────────────┤
│  프리미엄 (월 3,900원)                                      │
│  - 모든 점술 무제한                                         │
│  - 변효(變爻) 해석 추가                                     │
│  - 과거 기록 분석                                           │
│  - 광고 제거                                                │
├─────────────────────────────────────────────────────────────┤
│  프로 (월 9,900원)                                          │
│  - 프리미엄 전체                                            │
│  - 사주 + 주역 통합 분석                                    │
│  - 월간/연간 상세 리포트                                    │
│  - 1:1 AI 상담 (심화)                                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 리스크 및 대응

### 8.1 기술 리스크

| 리스크 | 영향 | 대응 |
|--------|------|------|
| Ollama 서버 장애 | 서비스 다운 | Groq 자동 failover |
| 카테고리 오매칭 | 엉뚱한 답변 | fallback 카테고리 + 사용자 수정 |
| 동시접속 폭주 | 응답 지연 | Redis 캐싱 + 큐잉 |
| 384효 데이터 오류 | 신뢰도 하락 | 전문가 검수 + 사용자 신고 |

### 8.2 법적 리스크

```
필수 면책 조항 (모든 결과 하단):

"본 서비스는 오락 및 참고 목적으로 제공됩니다.
 투자, 건강, 법률 등 중요 결정은 전문가와 상담하세요.
 운세 결과에 대한 법적 책임은 지지 않습니다."
```

### 8.3 데이터 리스크

| 리스크 | 대응 |
|--------|------|
| 크롤링 차단 | 다중 사이트 분산 수집 |
| 저작권 이슈 | 공개 데이터만 + 출처 명시 |
| 개인정보 노출 | 자동 마스킹 + 수동 검수 |

---

## 9. 일정 (MVP 기준)

```
Week 1: 프로젝트 셋업 + 384효 기본 데이터
  - Day 1-2: Next.js + FastAPI 프로젝트 생성
  - Day 3-5: PostgreSQL 스키마 + 384효 기본 입력
  - Day 6-7: 카테고리 250개 정의

Week 2: 질문 수집 + RAG 구축
  - Day 1-3: 크롤러 개발 + 10만 질문 수집
  - Day 4-5: ChromaDB 셋업 + 임베딩
  - Day 6-7: 카테고리 자동 매칭 테스트

Week 3: 핵심 기능 개발
  - Day 1-2: 점 치기 로직 (시초점 알고리즘)
  - Day 3-4: LLM 어투 변환 연동
  - Day 5-7: 5단계 UI 완성

Week 4: 테스트 + 배포
  - Day 1-3: 통합 테스트 + 버그 수정
  - Day 4-5: Vercel + Railway 배포
  - Day 6-7: 베타 테스트 + 피드백

Week 5-6: 확장
  - 타로 78장 추가
  - 사주 기본 기능
  - 프리미엄 결제 연동
```

---

## 10. 기술 스택 최종 정리

| 영역 | 기술 | 선택 이유 |
|------|------|----------|
| Frontend | Next.js 14 | SSR + 모바일 최적화 |
| Backend | FastAPI | 비동기 + 타입 힌트 |
| DB (관계형) | PostgreSQL | JSONB + 안정성 |
| DB (벡터) | ChromaDB | 경량 + 로컬 가능 |
| LLM | Ollama (Qwen2.5:7b) | 무료 + 한국어 우수 |
| 캐시 | Redis | 세션 + 응답 캐싱 |
| 배포 | Vercel + Railway | 간편 + 저비용 |
| 크롤링 | BeautifulSoup + Playwright | 정적/동적 대응 |

---

## 부록: 시초점(蓍草占) 알고리즘

전통 주역 점술 방식을 디지털로 구현

```python
import random

def shicho_divination():
    """
    시초점: 50개의 시초(막대기)로 괘를 뽑는 전통 방식
    6번 반복하여 6효를 구성
    """
    lines = []

    for _ in range(6):  # 6효
        # 49개 시초로 시작 (1개는 제외)
        total = 49

        values = []
        for _ in range(3):  # 3번 조작
            # 둘로 나눔
            left = random.randint(1, total - 1)
            right = total - left

            # 왼손에서 1개 빼기
            left -= 1

            # 4개씩 세어 나머지 계산
            left_remainder = left % 4 or 4
            right_remainder = right % 4 or 4

            removed = 1 + left_remainder + right_remainder
            total -= removed
            values.append(removed)

        # 나머지 시초 수로 효 결정
        yao_value = total // 4

        # 6=노음(변), 7=소양, 8=소음, 9=노양(변)
        if yao_value == 6:
            lines.append({"type": "yin", "changing": True})
        elif yao_value == 7:
            lines.append({"type": "yang", "changing": False})
        elif yao_value == 8:
            lines.append({"type": "yin", "changing": False})
        else:  # 9
            lines.append({"type": "yang", "changing": True})

    return lines

def lines_to_hexagram(lines):
    """6효를 64괘 번호로 변환"""
    binary = ""
    for line in lines:
        binary += "1" if line["type"] == "yang" else "0"

    # 상괘(4-6효) + 하괘(1-3효) 조합으로 괘 번호 결정
    lower = int(binary[0:3], 2)  # 하괘 (초효~삼효)
    upper = int(binary[3:6], 2)  # 상괘 (사효~상효)

    # 8괘 조합표에서 64괘 번호 조회
    hexagram_number = TRIGRAM_TO_HEXAGRAM[upper][lower]

    # 변효 위치 찾기
    changing_positions = [i+1 for i, line in enumerate(lines) if line["changing"]]

    return {
        "hexagram": hexagram_number,
        "changing_lines": changing_positions
    }
```

---

*작성일: 2024년*
*버전: 1.0*
*상태: 기획 완료*
