# 원격 PC 스크래퍼 관리도구 개발 기록

> **목적**: Claude 토큰 소진 시 Gemini가 이어서 작업할 수 있도록 상세 기록
> **최종 수정**: 2025-12-14 (세션 2)
> **상태**: ✅ 기본 기능 완료 + 웹 API 환경 분기 완료

---

## 1. 프로젝트 배경

### 1.1 목표
- 원격 PC에서 뉴스 스크래퍼를 GUI로 관리하는 도구 개발
- 웹 UI (`/admin/bot` 페이지)와 동일한 기능을 Python tkinter로 구현
- Windows 작업 스케줄러와 연동하여 자동 실행

### 1.2 요구사항
- 날짜 범위 선택 (시작일 ~ 종료일)
- 빠른 날짜 버튼 (오늘, 최근 1일~한달)
- 지역별 체크박스 선택 (26개 지역)
- 스크래퍼 실행 및 로그 표시
- **절대경로 사용 금지** - 모든 경로는 상대경로로

---

## 2. 파일 구조

```
d:\cbt\koreanews\
├── 원격/                          # ← 이 폴더를 원격 PC에 복사
│   ├── 스크래퍼_관리도구.pyw      # 메인 GUI 프로그램
│   ├── run_all_scrapers.py        # 일괄 실행 스크립트
│   ├── test_connection.py         # 연결 테스트
│   ├── setup_scheduler.bat        # 스케줄러 설정
│   └── README_설정가이드.txt      # 설정 가이드
├── scrapers/                       # 스크래퍼 파일들
│   ├── gwangju/
│   │   └── gwangju_scraper.py
│   ├── naju/
│   │   └── naju_scraper.py
│   └── ... (26개 지역)
└── 원격.md                         # 이 파일
```

---

## 3. 완료된 작업

### 3.1 스크래퍼_관리도구.pyw (GUI)

**파일 위치**: `d:\cbt\koreanews\원격\스크래퍼_관리도구.pyw`

#### 구현된 기능:
| 기능 | 상태 | 설명 |
|------|------|------|
| 날짜 선택 | ✅ | DateEntry (tkcalendar) 또는 Entry 폴백 |
| 빠른 날짜 버튼 | ✅ | 오늘, 최근 1일~한달 |
| 지역 체크박스 | ✅ | 8열 배치, 교육기관/지자체 분류 |
| 전체선택/해제 | ✅ | 링크 클릭으로 토글 |
| 새로고침 | ✅ | F5 단축키 + 버튼 (우측 상단) |
| **스크래퍼 실행** | ✅ | 실제 스크래퍼 연동 완료 |
| 실시간 로그 | ✅ | 중요 메시지 필터링 표시 |
| 중지 버튼 | ✅ | 실행 중 프로세스 종료 |
| 설정 내보내기/가져오기 | ✅ | JSON 형식 |

#### 핵심 코드 구조:
```python
# 경로 설정 (23-31행)
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))  # 원격 폴더
PROJECT_DIR = os.path.dirname(SCRIPT_DIR)  # koreanews 폴더
SCRAPERS_DIR = os.path.join(PROJECT_DIR, 'scrapers')

# 독립 실행 모드 지원
LOCAL_SCRAPERS_DIR = os.path.join(SCRIPT_DIR, 'scrapers')
if os.path.exists(LOCAL_SCRAPERS_DIR):
    SCRAPERS_DIR = LOCAL_SCRAPERS_DIR
```

#### 스크래퍼 실행 로직 (run_scraper 함수, 540-657행):
```python
def run_scraper(self):
    # 1. 선택된 지역 확인
    selected = [code for code, var in self.region_vars.items() if var.get()]

    # 2. 날짜 계산 (days)
    days = (end - start).days + 1

    # 3. 스레드에서 각 지역 순차 실행
    for region_code in selected:
        scraper_path = os.path.join(SCRAPERS_DIR, region_code, f"{region_code}_scraper.py")
        cmd = [sys.executable, scraper_path, "--days", str(days), "--max-articles", "30"]
        # subprocess.Popen으로 실행
        # 출력 실시간 로그 표시
```

### 3.2 run_all_scrapers.py

**파일 위치**: `d:\cbt\koreanews\원격\run_all_scrapers.py`

#### 수정 내용:
- 절대경로 → 상대경로로 변경
- 독립 실행 모드 지원 (원격/scrapers/ 폴더 우선)

```python
# 경로 설정 (21-29행)
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.dirname(SCRIPT_DIR)
SCRAPERS_DIR = os.path.join(PROJECT_ROOT, 'scrapers')

# 독립 실행 모드
LOCAL_SCRAPERS_DIR = os.path.join(SCRIPT_DIR, 'scrapers')
if os.path.exists(LOCAL_SCRAPERS_DIR):
    SCRAPERS_DIR = LOCAL_SCRAPERS_DIR
```

---

## 4. UI 수정 이력

| 날짜 | 변경 내용 |
|------|----------|
| 12-14 | 초기 GUI 생성 (웹 UI 복제) |
| 12-14 | tkcalendar 없을 때 폴백 처리 |
| 12-14 | 체크박스 열 수: 5 → 7 → **8열** |
| 12-14 | 글자색 통일 (#1f2937), 숫자색 파란색 (#2563eb) |
| 12-14 | 새로고침 버튼 우측 상단에 추가 |
| 12-14 | **스크래퍼 실행 기능 연동 완료** |

---

## 5. 테스트 방법

### 5.1 GUI 실행 테스트
```bash
# 원격 폴더에서 실행
cd d:\cbt\koreanews\원격
python 스크래퍼_관리도구.pyw
```

### 5.2 스크래퍼 실행 테스트
1. GUI 실행
2. 지역 1~2개 선택 (예: 광주광역시)
3. 날짜 선택 (오늘)
4. "수집 시작" 클릭
5. 로그 확인

### 5.3 예상 로그 출력
```
[HH:MM:SS] ℹ️ 스크래퍼 실행 시작: 1개 지역, 1일간
[HH:MM:SS] ℹ️ 스크래퍼 폴더: d:\cbt\koreanews\scrapers
[HH:MM:SS] ℹ️ [RUN] gwangju 수집 시작...
[HH:MM:SS] ✅   신규 3건 저장 완료
[HH:MM:SS] ✅ [OK] gwangju: 3건 수집 완료
```

---

## 6. 남은 작업 (Gemini 참고)

### 6.1 테스트 필요
- [ ] GUI에서 실제 스크래퍼 실행 테스트
- [ ] 여러 지역 동시 선택 후 순차 실행 확인
- [ ] 중지 버튼 동작 확인
- [ ] 오류 발생 시 로그 표시 확인
- [ ] 스크래퍼 활성 상태 (●) 표시 확인

### 6.2 추가 개선 가능
- [ ] 실행 결과 요약 표시 (성공/실패 건수)
- [ ] 마지막 실행 시간 표시
- [ ] 자동 실행 스케줄 설정 UI

### 6.3 완료된 기능 (2024-12-14 추가)
- [x] **스크래퍼 활성 상태 동적 확인**: `/api/bot/scraper-status`와 동일한 로직
  - `check_scraper_status(region_code)` 함수 추가
  - 폴더 내 파일 3개 이상이면 활성 (●녹색), 미만이면 비활성 (●회색)
  - 하드코딩 → 동적 스캔으로 변경

### 6.3 원격 PC 배포
1. `원격` 폴더 전체를 원격 PC에 복사
2. Python 설치 확인
3. 필요 패키지 설치: `pip install playwright tkcalendar`
4. `스크래퍼_관리도구.pyw` 더블클릭 실행

---

## 7. 주요 코드 참조

### 7.1 지역 데이터 (REGIONS)
```python
REGIONS = {
    "교육기관": [
        {"code": "gwangju_edu", "name": "광주광역시교육", "active": True, "count": None},
        {"code": "jeonnam_edu", "name": "전라남도교육청", "active": True, "count": None},
    ],
    "지자체": [
        {"code": "gwangju", "name": "광주광역시", "active": True, "count": 15},
        {"code": "jeonnam", "name": "전라남도", "active": True, "count": 10},
        # ... 24개 지역
    ]
}
```

### 7.2 스크래퍼 호출 명령어
```python
cmd = [sys.executable, scraper_path, "--days", str(days), "--max-articles", "30"]
```

### 7.3 로그 레벨
```python
self.log_text.tag_configure("success", foreground="#059669")  # 녹색
self.log_text.tag_configure("error", foreground="#dc2626")    # 빨간색
self.log_text.tag_configure("info", foreground="#2563eb")     # 파란색
self.log_text.tag_configure("warning", foreground="#d97706")  # 주황색
```

---

## 8. 웹 API 환경 분기 (2025-12-14 세션 2)

### 8.1 배경
- 로컬 PC: `localhost:3000`에서 개발/테스트, Python 스크래퍼 직접 실행 가능
- Vercel 서버: Python 실행 불가, 파일 시스템 접근 제한

### 8.2 수정된 API 파일

#### `/api/bot/run/route.ts`
```typescript
// 로컬 환경인지 확인
function isLocalEnvironment(req: NextRequest): boolean {
    const host = req.headers.get('host') || '';
    return host.includes('localhost') || host.includes('127.0.0.1');
}

// Vercel 환경 → 안내 메시지 반환 (503)
if (!isLocalEnvironment(req)) {
    return NextResponse.json({
        message: '⚠️ 서버에서는 스크래퍼를 실행할 수 없습니다.\n\n로컬 관리도구를 사용하세요...',
        isServerMode: true
    }, { status: 503 });
}
```

#### `/api/bot/stop/route.ts`
```typescript
// 동일한 isLocalEnvironment() 체크 추가
// Vercel 환경 → 안내 메시지 반환 (503)
```

#### `/api/bot/scraper-status/route.ts`
```typescript
// Vercel 환경용 기본 활성 스크래퍼 목록
const DEFAULT_ACTIVE_REGIONS = [
    'gwangju', 'gwangju_edu', 'jeonnam', 'jeonnam_edu', ...
];

// Vercel 환경: 기본 목록 기반으로 상태 반환
// 로컬 환경: 실제 파일 시스템 스캔
```

### 8.3 작동 방식
```
┌─────────────────────────────────────────────────────────────┐
│  접속 환경별 동작                                            │
├─────────────────────────────────────────────────────────────┤
│  localhost:3000 (로컬)                                       │
│    → /api/bot/run: Python 스크래퍼 실행                      │
│    → /api/bot/stop: taskkill로 프로세스 종료                 │
│    → /api/bot/scraper-status: 실제 폴더 스캔                 │
├─────────────────────────────────────────────────────────────┤
│  koreanews.vercel.app (Vercel)                              │
│    → /api/bot/run: "로컬 관리도구 사용하세요" 메시지          │
│    → /api/bot/stop: "원격 PC에서 직접 중지하세요" 메시지      │
│    → /api/bot/scraper-status: 기본 활성 목록 반환            │
└─────────────────────────────────────────────────────────────┘
```

### 8.4 워크플로우
1. **개발/테스트**: 로컬 PC에서 `npm run dev` → Claude와 대화하며 수정
2. **자동 수집**: 원격 PC에서 Windows 작업 스케줄러로 자동 실행
3. **배포된 사이트**: Vercel에서는 뉴스 조회만 가능

---

## 9. 문제 해결

### 9.1 tkcalendar 없음
- 프로그램 시작 시 설치 여부 묻는 대화상자 표시
- "아니오" 선택 시 Entry 위젯으로 폴백 (수동 입력)

### 9.2 스크래퍼 파일 없음
- `[SKIP] region_code: 스크래퍼 파일 없음` 로그 출력
- 다음 지역으로 계속 진행

### 9.3 실행 타임아웃
- 5분(300초) 타임아웃 설정
- `[TIMEOUT] region_code: 5분 초과` 로그 출력

---

## 10. 세션 기록 (다음 작업자 참고)

### 세션 1 (2025-12-14)
- GUI 기본 구현 (`스크래퍼_관리도구.pyw`)
- 스크래퍼 실행 기능 연동
- 동적 스크래퍼 상태 확인 기능 추가

### 세션 2 (2025-12-14, 컨텍스트 이어서)
**완료된 작업:**
1. ✅ `/api/bot/run/route.ts` - localhost 체크 추가
   - `isLocalEnvironment()` 함수로 host 확인
   - Vercel → 503 + 안내 메시지

2. ✅ `/api/bot/stop/route.ts` - localhost 체크 추가
   - 동일한 `isLocalEnvironment()` 함수
   - Vercel → 503 + 안내 메시지

3. ✅ `/api/bot/scraper-status/route.ts` - 환경별 분기
   - Vercel → `DEFAULT_ACTIVE_REGIONS` 기본값 반환
   - 로컬 → 실제 파일 시스템 스캔

4. ✅ `원격.md` 문서 업데이트

**수정된 파일 전체 목록:**
```
src/app/api/bot/run/route.ts          ← localhost 체크 추가
src/app/api/bot/stop/route.ts         ← localhost 체크 추가
src/app/api/bot/scraper-status/route.ts ← 환경별 분기 추가
원격.md                                ← 이 파일
원격/스크래퍼_관리도구.pyw             ← 이전 세션에서 수정
원격/run_all_scrapers.py              ← 이전 세션에서 수정
```

### 다음 작업 (선택사항)
- [ ] 프론트엔드에서 `isServerMode` 응답 처리 (안내 메시지 UI 표시)
- [ ] 테스트: 로컬에서 스크래퍼 실행/중지 확인
- [ ] 테스트: Vercel 배포 후 안내 메시지 표시 확인
- [ ] git commit & push

### 핵심 설계 결정
```
┌─────────────────────────────────────────────────────────────┐
│  환경 판별 로직 (모든 API 공통)                              │
├─────────────────────────────────────────────────────────────┤
│  function isLocalEnvironment(req: NextRequest): boolean {   │
│      const host = req.headers.get('host') || '';            │
│      return host.includes('localhost')                      │
│          || host.includes('127.0.0.1');                     │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
```

---

**작성자**: Claude
**다음 작업자**: Gemini 또는 Claude (새 세션)
