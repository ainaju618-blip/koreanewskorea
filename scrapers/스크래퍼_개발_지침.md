# 스크래퍼 개발 지침서
> **위치:** `D:\cbt\koreanews\scrapers\`  
> **버전:** v2.0  
> **최종 수정:** 2025-12-12

---

## 📋 개요

각 기관 웹사이트마다 구조가 다르므로 스크래핑 방법도 다릅니다.  
이 문서는 **외부 동료와 협업하여 효율적으로 스크래퍼를 개발하는 표준 워크플로우**를 정의합니다.

---

## 🔄 협업 워크플로우

```
┌─────────────────────────────────────────────────────────────┐
│  1. 개발자가 "기초 데이터 요청서"를 작성                      │
│     ↓                                                        │
│  2. 사용자가 외부 동료에게 전달                              │
│     ↓                                                        │
│  3. 외부 동료가 사이트 분석 후 기초 데이터 제공              │
│     ↓                                                        │
│  4. 개발자가 기초 데이터로 스크래퍼 개발 및 테스트           │
│     ↓                                                        │
│  5. 문제 발생 시 → 상황 설명 → 동료가 추가 데이터 제공      │
│     ↓                                                        │
│  6. 완성 후 ALGORITHM.md 문서 작성                           │
└─────────────────────────────────────────────────────────────┘
```

**핵심 원칙:**
- 개발자는 직접 사이트를 탐색하지 않음
- 외부 동료가 현장에서 필요한 정보를 추출
- "이것 저것 달라"가 아닌 "우리 상황은 이렇다"로 요청

---

## 📝 외부 동료에게 전달할 기초 데이터 요청서

아래 전체 내용을 외부 동료에게 전달합니다.

---

### 0. 협업 과정 안내

우리는 아래와 같은 방식으로 협업합니다:

```
┌─────────────────────────────────────────────────────────────┐
│  1. 개발자가 "기초 데이터 요청서"를 작성 (이 문서)           │
│     ↓                                                        │
│  2. 사용자가 외부 동료(당신)에게 전달                        │
│     ↓                                                        │
│  3. 외부 동료가 사이트 분석 후 기초 데이터 제공 ← 당신의 역할│
│     ↓                                                        │
│  4. 개발자가 기초 데이터로 스크래퍼 개발 및 테스트           │
│     ↓                                                        │
│  5. 문제 발생 시 → 상황 설명 → 동료가 추가 데이터 제공      │
│     ↓                                                        │
│  6. 완성 후 ALGORITHM.md 문서 작성                           │
└─────────────────────────────────────────────────────────────┘
```

**당신의 역할:** 실제 웹사이트에 접속하여 아래 요청한 정보를 분석/추출해서 제공해 주세요.

---

> [!CAUTION]
> ## ⚠️ 작업 범위 제한 (매우 중요!)
> 
> **전체 데이터를 분석하지 마세요!** 아래 범위만 확인하면 됩니다:
> 
> | 항목 | 범위 |
> |------|------|
> | 목록 페이지 | **1페이지만** (첫 화면) |
> | 샘플 기사 | **최신 5개만** |
> | 상세 페이지 | **1~2개만** 방문하여 구조 파악 |
> | 총 기사 수 | 숫자만 확인 (예: "총 1,234건") |
> | 페이지네이션 | 2페이지 URL 패턴만 확인 |
> 
> **이유:** 모든 기사의 구조가 동일하므로, 5개 샘플이면 스크래퍼 개발에 충분합니다.
> 1000개 이상을 분석하면 시간만 낭비됩니다!

---

### 1. 프로젝트 개요

**"코리아뉴스"** - 전남/광주 지역 뉴스 통합 플랫폼

전라남도, 광주광역시, 광주교육청, 전남교육청, 그리고 전남의 22개 시군 보도자료를 **자동으로 수집**하여 하나의 웹사이트에 통합 게시하는 시스템입니다.

---

### 2. 기술 스택

| 구분 | 기술 |
|------|------|
| 프론트엔드/백엔드 | Next.js 16 (App Router) |
| 데이터베이스 | Supabase (PostgreSQL) |
| 스크래퍼 | Python (Playwright) |
| 이미지 저장 | Cloudinary |

**데이터 흐름:**
```
[스크래퍼] → POST /api/bot/ingest → [Supabase DB] → [웹사이트 표시]
```

---

### 3. 서버로 전송하는 필드 (API 스펙)

| 필드명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| `title` | string | ✅ | 기사 제목 |
| `original_link` | string | ✅ | 상세 페이지 URL (중복 체크 키) |
| `content` | string | ⭕ | 본문 내용 (메뉴/푸터 제외) |
| `source` | string | ⭕ | 작성 기관명 (예: "나주시") |
| `category` | string | ⭕ | 카테고리 (예: "전남", "광주") |
| `region` | string | ⭕ | 지역 코드 (예: "naju", "gwangju") |
| `published_at` | string | ⭕ | 발행일 (ISO 8601) |
| `thumbnail_url` | string | ⭕ | 대표 이미지 URL |

---

### 4. 이미지 처리 방식 (중요!)

**문제:**
- 대부분의 관공서 사이트는 **핫링크 방지** 적용
- 외부에서 이미지 URL 직접 접근 시 **403 Forbidden**

**우리의 해결 방식:**
1. 이미지 URL 추출
2. 스크래퍼가 이미지 다운로드 (Referer 헤더 포함)
3. **가로 800px 기준으로 리사이즈 (세로는 비율 유지)**
4. Cloudinary에 업로드
5. Cloudinary URL을 thumbnail_url로 저장

**동료에게 필요한 정보:**
- 이미지 위치 (본문 내 img? 첨부파일?)
- URL이 절대경로인지 상대경로인지
- 외부 접근 가능 여부
- 안 되면 어떤 헤더/세션 필요한지

---

### 5. 스크래퍼 구조 (참고용)

```python
# 1. 목록 페이지에서 기사 링크들 수집
for row in 목록페이지_행들:
    title = row에서_제목_추출
    href = row에서_링크_추출
    article_id = href에서_ID_추출
    
# 2. 각 상세 페이지 방문
for article in 수집된_기사들:
    상세페이지_접속(article.url)
    content = 본문_추출()
    date = 작성일_추출()
    image_url = 이미지_추출()
    
    # 3. Cloudinary 업로드
    if image_url:
        cloudinary_url = download_and_upload_image(image_url)
    
    # 4. 서버 전송
    send_article_to_server({title, content, date, cloudinary_url, ...})
```

---

### 6. 사이트별로 알아야 할 것들

**[목록 페이지]**
- 기사 목록의 테이블/리스트 위치
- 제목 링크 위치
- 기사 ID 추출 방법 (예: bs_idx=12345)
- 페이지네이션 URL 패턴

**[상세 페이지]**
- 본문 텍스트 영역 (CSS 셀렉터 또는 구조)
- 작성일 위치 및 형식
- 이미지 위치

---

### 7. 요청하는 출력 형식

```
## [기관명] 보도자료 스크래핑 가이드

### 1. URL 정보
- 목록 URL: https://...
- 상세 페이지 URL 패턴: ?idx={ID}&mode=view
- 페이지네이션: ?page={N} 또는 ?offset={N*10}

### 2. 목록 페이지 구조
- 기사 행 위치: (예: table tbody tr)
- 제목 링크 위치: (예: td:nth-child(2) a)
- 날짜 컬럼: (예: td:nth-child(4))
- ID 추출 방법: (예: href에서 idx=(\d+) 정규식)

### 3. 상세 페이지 구조
- 본문 영역: (예: div.view_content)
- 작성일 위치: (예: th:has-text("작성일") + td)
- 이미지 위치: (예: 첨부파일 또는 본문 내 img)

### 4. 이미지 접근
- 핫링크 허용: 예/아니오
- 안 되면: Referer 필요, 세션 필요 등

### 5. 샘플 데이터 (5개)
[
  {
    "id": "12345",
    "title": "기사 제목",
    "date": "2025-12-12",
    "url": "https://...",
    "content": "본문 내용...",
    "image_url": "https://..."
  }
]
```

---

### 8. 추가/특수 사항

위에서 언급하지 않은 특수한 상황이 있다면 함께 알려주세요:

- **로그인/인증**이 필요한 경우
- **JavaScript 동적 로딩** 콘텐츠
- **iframe** 안에 본문이 있는 경우
- **HWP 뷰어**로 문서가 표시되는 경우
- **AJAX/API 호출**로 데이터를 가져오는 경우
- **CAPTCHA**나 접근 제한
- 기타 **일반적이지 않은 구조**

---

### 9. 문제 발생 시

테스트 중 문제가 생기면 구체적인 상황을 설명하겠습니다:
- 어떤 셀렉터가 안 되는지
- 어떤 데이터가 빠지는지
- 어떤 에러가 발생하는지

해당 문제에 맞는 추가 정보를 제공해 주세요.

---

## 📁 폴더 구조 규칙

새 스크래퍼 생성 시 반드시 아래 구조를 따릅니다:

```
scrapers/
├── [기관명]/
│   ├── [기관명]_scraper.py    # 메인 스크래퍼 코드
│   └── ALGORITHM.md           # 알고리즘 문서 (필수!)
```

---

## 📋 ALGORITHM.md 작성 규칙

스크래퍼 완성 후 반드시 `ALGORITHM.md` 파일을 작성해야 합니다.

### 필수 포함 항목

| 섹션 | 내용 |
|------|------|
| **개요** | 대상 사이트, Region Code, Category |
| **동작 흐름** | Phase별 설명 (Collect → Visit → Verify → Ingest) |
| **셀렉터** | 목록, 본문, 이미지, 날짜 추출 셀렉터 |
| **설정값** | BASE_URL, LIST_URL, REGION_CODE 등 |
| **특이사항** | 핫링크 방지, HWP iframe 등 사이트별 주의점 |
| **실행 방법** | CLI 명령어 예시 |

### 참고 예시
- `scrapers/jeonnam/ALGORITHM.md`
- `scrapers/gwangju/ALGORITHM.md`
- `scrapers/naju/ALGORITHM.md`

---

## ⚠️ 주의사항

1. **🖼️ Cloudinary 업로드 필수**  
   모든 스크래퍼에서 이미지는 **반드시 Cloudinary에 업로드**
   ```python
   from utils.cloudinary_uploader import download_and_upload_image
   
   if thumbnail_url:
       cloudinary_url = download_and_upload_image(thumbnail_url, BASE_URL, folder="region_code")
       if cloudinary_url:
           thumbnail_url = cloudinary_url
   ```

2. **처리 제한**: 1회 실행 시 최대 10개 기사

3. **부하 조절**: 각 기사 처리 후 `time.sleep(1)` 적용

---

## 🧪 테스트 방법

```bash
# 기본 실행 (최대 10개)
python [기관명]_scraper.py

# 최대 5개만 수집
python [기관명]_scraper.py --max-articles 5

# 날짜 필터 적용 (최근 30일)
python [기관명]_scraper.py --days 30
```

---

## 📊 기존 스크래퍼 참조

| 기관 | 폴더 | 특이사항 |
|------|------|----------|
| 전라남도 | `jeonnam/` | 첨부파일 이미지 추출, Phase 구조 |
| 광주광역시 | `gwangju/` | 핫링크 방지, Cloudinary 필수 |
| 광주시교육청 | `gwangju_edu/` | JS evaluate 사용, 특수 URL 패턴 |
| 나주시 | `naju/` | img 다음 div에서 본문 추출 |

---

## 🌐 전남 시군 보도자료 URL 목록

### 광역/도
| 기관 | 보도자료 URL |
|------|-------------|
| 광주광역시 | https://www.gwangju.go.kr/boardList.do?boardId=BD_0000000027&pageId=www789 |
| 전라남도 | https://www.jeonnam.go.kr/M7116/boardList.do?menuId=jeonnam0202000000 |

### 시 (5개)
| 기관 | 보도자료 URL |
|------|-------------|
| 목포시 | https://www.mokpo.go.kr/www/mokpo_news/press_release/report_material |
| 여수시 | https://www.yeosu.go.kr/www/govt/news/release/press |
| 순천시 | http://www.suncheon.go.kr/kr/news/0006/0001/ |
| 나주시 | https://www.naju.go.kr/www/administration/reporting/coverage |
| 광양시 | https://gwangyang.go.kr/board.es?mid=a11007000000&bid=0057 |

### 군 (17개)
| 기관 | 보도자료 URL |
|------|-------------|
| 담양군 | https://www.damyang.go.kr/board/list.damyang?boardId=BBS_0000021&menuId=DAMYANG000052 |
| 곡성군 | https://www.gokseong.go.kr/kr/board/list.do?bbsId=BBS_000000000000151&menuNo=102001002000 |
| 구례군 | https://www.gurye.go.kr/board/list.do?bbsId=BBS_0000000000000300&menuNo=115004006000 |
| 고흥군 | https://www.goheung.go.kr/www/news/press |
| 보성군 | https://www.boseong.go.kr/www/news/press |
| 화순군 | https://www.hwasun.go.kr/www/news/press |
| 장흥군 | https://www.jangheung.go.kr/www/news/press |
| 강진군 | https://www.gangjin.go.kr/contents.do?idx=865 |
| 해남군 | https://www.haenam.go.kr/www/news/press |
| 영암군 | https://www.yeongam.go.kr/home/www/open_info/yeongam_news/press |
| 무안군 | https://www.muan.go.kr/www/news/press |
| 함평군 | https://www.hampyeong.go.kr/boardList.do?pageId=www275&boardId=NEWS |
| 영광군 | https://www.yeonggwang.go.kr/bbs/?b_id=news_data&site=headquarter_new&mn=9056 |
| 장성군 | https://www.jangseong.go.kr/www/news/press |
| 완도군 | https://www.wando.go.kr/wando/sub.cs?m=299 |
| 진도군 | https://www.jindo.go.kr/www/news/press |
| 신안군 | https://www.shinan.go.kr/www/news/press |

### 교육청 (2개)
| 기관 | 보도자료 URL |
|------|-------------|
| 광주교육청 | https://enews.gen.go.kr/v5/?sid=25 |
| 전남교육청 | https://www.jne.go.kr/www/news/press |
